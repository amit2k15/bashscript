import pymysql
from openpyxl import Workbook
from openpyxl.utils import get_column_letter
from openpyxl.styles import Alignment

# Database connection details
db_host = 'localhost'
db_user = 'your_username'
db_password = 'your_password'
db_name = 'zabbix'

# Host group name and item key
host_group_name = 'Your Host Group Name'
item_key = 'system.cpu.util'

# Connect to the database
connection = pymysql.connect(host=db_host, user=db_user, password=db_password, database=db_name)
cursor = connection.cursor()

# Get the host group ID
cursor.execute("SELECT groupid FROM groups WHERE name = %s", (host_group_name,))
group_id = cursor.fetchone()[0]

# Get the item ID for the specified key
cursor.execute("SELECT itemid FROM items WHERE key_ = %s", (item_key,))
item_id = cursor.fetchone()[0]

# Get the average values for the last week and last month
cursor.execute("SELECT AVG(value), clock FROM history WHERE itemid = %s AND clock >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 WEEK)) GROUP BY clock", (item_id,))
last_week_data = cursor.fetchall()

cursor.execute("SELECT AVG(value), clock FROM history WHERE itemid = %s AND clock >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH)) GROUP BY clock", (item_id,))
last_month_data = cursor.fetchall()

# Create a new Excel workbook
wb = Workbook()
ws = wb.active
ws.title = 'Zabbix Report'

# Write headers
ws['A1'] = 'Date'
ws['B1'] = 'Average CPU Utilization'

# Write last week's data
ws['A2'] = 'Last Week'
ws.merge_cells('A2:B2')
ws['A2'].alignment = Alignment(horizontal='center')
row = 3
for avg, timestamp in last_week_data:
    ws.cell(row=row, column=1, value=timestamp)
    ws.cell(row=row, column=2, value=avg)
    row += 1

# Write last month's data
ws['A' + str(row)] = 'Last Month'
ws.merge_cells('A' + str(row) + ':B' + str(row))
ws['A' + str(row)].alignment = Alignment(horizontal='center')
row += 1
for avg, timestamp in last_month_data:
    ws.cell(row=row, column=1, value=timestamp)
    ws.cell(row=row, column=2, value=avg)
    row += 1

# Set column widths
ws.column_dimensions['A'].width = 20
ws.column_dimensions['B'].width = 20

# Save the workbook
wb.save('zabbix_report.xlsx')

# Close the database connection
cursor.close()
connection.close()
