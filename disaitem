import requests
import openpyxl

# Zabbix API configuration
ZABBIX_URL = "https://your-zabbix-instance/api_jsonrpc.php"
ZABBIX_USERNAME = "your-username"
ZABBIX_PASSWORD = "your-password"

# Excel file configuration
EXCEL_FILE = "disabled_items_report.xlsx"

def get_disabled_items():
    # Authenticate to Zabbix API
    payload = {
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "user": ZABBIX_USERNAME,
            "password": ZABBIX_PASSWORD
        },
        "id": 1,
    }
    response = requests.post(ZABBIX_URL, json=payload, verify=False)
    auth_result = response.json()

    if "result" in auth_result:
        auth_token = auth_result["result"]
        
        # Get disabled items
        payload = {
            "jsonrpc": "2.0",
            "method": "item.get",
            "params": {
                "output": ["itemid", "name", "hostid", "status"],
                "filter": {"status": 1},  # Disabled items
                "selectHosts": ["host"],
                "selectGroups": ["groupid", "name"]
            },
            "auth": auth_token,
            "id": 2,
        }
        response = requests.post(ZABBIX_URL, json=payload, verify=False)
        items_result = response.json()

        if "result" in items_result:
            return items_result["result"]

    return []

def create_excel_report(items):
    workbook = openpyxl.Workbook()
    worksheet = workbook.active
    worksheet.append(["Host Group", "Host", "Item Name"])

    for item in items:
        host_group = item["groups"][0]["name"]
        host = item["hosts"][0]["host"]
        item_name = item["name"]
        worksheet.append([host_group, host, item_name])

    workbook.save(EXCEL_FILE)
    print(f"Excel report saved as {EXCEL_FILE}")

if __name__ == "__main__":
    disabled_items = get_disabled_items()
    create_excel_report(disabled_items)
