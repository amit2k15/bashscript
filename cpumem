import pymysql
from openpyxl import Workbook
from datetime import datetime, timedelta

# MySQL database connection parameters
db_config = {
    'host': 'your_mysql_host',
    'user': 'your_mysql_user',
    'password': 'your_mysql_password',
    'database': 'your_zabbix_database',
}

# Zabbix item key and host group name
item_key = 'system.cpu.util'
hostgroup_name = 'your_hostgroup_name'

# Connect to the MySQL database
connection = pymysql.connect(**db_config)

try:
    with connection.cursor() as cursor:
        # Calculate date ranges for the last week and last month
        end_date = datetime.now()
        last_week_start_date = end_date - timedelta(days=7)
        last_month_start_date = end_date - timedelta(days=30)

        # Fetch data for the last week
        last_week_query = (
            f"SELECT h.host, i.name, AVG(hd.value) as avg_cpu_util "
            f"FROM history h "
            f"JOIN items i ON h.itemid = i.itemid "
            f"JOIN hosts_groups hg ON h.hostid = hg.hostid "
            f"JOIN groups g ON hg.groupid = g.groupid "
            f"JOIN history_uint hd ON h.itemid = hd.itemid AND h.clock = hd.clock "
            f"WHERE i.key_ = '{item_key}' "
            f"AND g.name = '{hostgroup_name}' "
            f"AND h.clock >= {int(last_week_start_date.timestamp())} "
            f"AND h.clock <= {int(end_date.timestamp())} "
            f"GROUP BY h.host, i.name"
        )

        cursor.execute(last_week_query)
        last_week_data = cursor.fetchall()

        # Fetch data for the last month
        last_month_query = (
            f"SELECT h.host, i.name, AVG(hd.value) as avg_cpu_util "
            f"FROM history h "
            f"JOIN items i ON h.itemid = i.itemid "
            f"JOIN hosts_groups hg ON h.hostid = hg.hostid "
            f"JOIN groups g ON hg.groupid = g.groupid "
            f"JOIN history_uint hd ON h.itemid = hd.itemid AND h.clock = hd.clock "
            f"WHERE i.key_ = '{item_key}' "
            f"AND g.name = '{hostgroup_name}' "
            f"AND h.clock >= {int(last_month_start_date.timestamp())} "
            f"AND h.clock <= {int(end_date.timestamp())} "
            f"GROUP BY h.host, i.name"
        )

        cursor.execute(last_month_query)
        last_month_data = cursor.fetchall()

finally:
    connection.close()

# Create an Excel workbook and add a worksheet
wb = Workbook()
ws = wb.active

# Write headers to the worksheet
headers = ["Host", "Item Name", "Average CPU Utilization (Last Week)", "Average CPU Utilization (Last Month)"]
ws.append(headers)

# Write data to the worksheet
for row in last_week_data:
    ws.append(row + (None,))  # Append None for the last month column

for row in last_month_data:
    ws.append((row[0], row[1], None, row[2]))  # Append None for the last week column

# Save the workbook to a file
wb.save("cpu_utilization_report.xlsx")
