from pyzabbix import ZabbixAPI
import pandas as pd

# Replace these variables with your Zabbix server and credentials
ZABBIX_SERVER = 'http://your_zabbix_server/zabbix'
USERNAME = 'your_username'
PASSWORD = 'your_password'
HOST_GROUP = 'your_host_group_name'

# Connect to Zabbix server
zapi = ZabbixAPI(ZABBIX_SERVER)
zapi.login(USERNAME, PASSWORD)

# Get the host group ID
host_group_id = zapi.hostgroup.get(filter={"name": HOST_GROUP})[0]['groupid']

# Get hosts in the specified host group
hosts = zapi.host.get(groupids=host_group_id, output=['hostid', 'name', 'status'])

# Get web scenarios for hosts
web_scenarios = zapi.httptest.get(hostids=[host['hostid'] for host in hosts], output=['httptestid', 'name', 'status', 'delay'])
web_scenario_ids = [ws['httptestid'] for ws in web_scenarios]

# Get web scenario steps (to get URLs)
web_steps = zapi.httpstep.get(httptestids=web_scenario_ids, output=['url'])

# Get triggers for hosts
triggers = zapi.trigger.get(hostids=[host['hostid'] for host in hosts], output=['description', 'priority', 'status'])

# Create a dictionary for host data
host_data = {host['hostid']: {'name': host['name'], 'status': 'Enabled' if host['status'] == '0' else 'Disabled'} for host in hosts}

# Create a dictionary for web scenario data
web_scenario_data = {ws['httptestid']: {'name': ws['name'], 'status': 'Enabled' if ws['status'] == '0' else 'Disabled', 'delay': ws['delay']} for ws in web_scenarios}

# Create a dictionary for web step data (URLs)
web_step_data = {ws['httptestid']: ws['url'] for ws in web_steps}

# Create a dictionary for trigger data
trigger_data = {}
for trigger in triggers:
    severity_map = {1: 'Information', 2: 'Minor', 3: 'Warning', 4: 'Major'}
    trigger_data[trigger['triggerid']] = {
        'description': trigger['description'],
        'severity': severity_map.get(int(trigger['priority']), 'Unknown'),
        'status': 'Enabled' if trigger['status'] == '0' else 'Disabled'
    }

# Combine data
combined_data = []
for ws_id, ws_info in web_scenario_data.items():
    host_id = next(host['hostid'] for host in hosts if host['hostid'] in web_scenario_ids)
    url = web_step_data.get(ws_id, '')
    for trigger_id, trigger_info in trigger_data.items():
        if url in trigger_info['description']:
            combined_data.append({
                'Host Name': host_data[host_id]['name'],
                'Host Status': host_data[host_id]['status'],
                'Web Scenario Name': ws_info['name'],
                'Web Scenario Status': ws_info['status'],
                'URL': url,
                'Delay': ws_info['delay'],
                'Trigger Name': trigger_info['description'],
                'Trigger Severity': trigger_info['severity'],
                'Trigger Status': trigger_info['status']
            })

# Convert to DataFrame and save to Excel
df = pd.DataFrame(combined_data)
df.to_excel('zabbix_report.xlsx', index=False)
print('Report generated successfully!')
