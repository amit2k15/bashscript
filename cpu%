import pandas as pd
import mysql.connector
from openpyxl import Workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# MySQL database connection details
db_host = 'localhost'
db_name = 'zabbix'
db_user = 'username'
db_password = 'password'

# Host group name for which the report is generated
host_group = 'YourHostGroup'

# Establishing MySQL connection
cnx = mysql.connector.connect(
    host=db_host,
    database=db_name,
    user=db_user,
    password=db_password
)

# Query to fetch average CPU utilization for the last week for the given host group
query = f"""
    SELECT
        h.name AS host,
        AVG(hi.value) AS avg_cpu_utilization
    FROM
        hosts h
    INNER JOIN
        items i ON i.hostid = h.hostid
    INNER JOIN
        history hi ON hi.itemid = i.itemid
    WHERE
        h.status = 0
        AND h.hostid IN (
            SELECT
                hg.hostid
            FROM
                hosts_groups hg
            INNER JOIN
                groups g ON g.groupid = hg.groupid
            WHERE
                g.name = '{host_group}'
        )
        AND i.key_ = 'system.cpu.util'
        AND hi.clock >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 WEEK))
    GROUP BY
        h.hostid
"""

# Fetching data from the database
df = pd.read_sql(query, cnx)

# Creating Excel workbook and worksheet
wb = Workbook()
ws = wb.active

# Writing the data to the worksheet
for row in dataframe_to_rows(df, index=False, header=True):
    ws.append(row)

# Saving the workbook
wb.save('zabbix_report.xlsx')

# Closing the database connection
cnx.close()
