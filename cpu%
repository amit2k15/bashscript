import pymysql
import pandas as pd
from openpyxl import Workbook

# MySQL connection details
host = 'your_mysql_host'
port = 3306
database = 'your_database_name'
username = 'your_username'
password = 'your_password'

# Specific host group name
host_group = 'your_host_group_name'

# Connect to the MySQL database
connection = pymysql.connect(host=host, port=port, user=username, password=password, database=database)

# Execute the SQL query to retrieve data
query = """
SELECT h.name AS host, AVG(id.avg) AS avg_cpu_utilization
FROM hosts h
JOIN items i ON h.hostid = i.hostid
JOIN (
    SELECT itemid, AVG(value) AS avg
    FROM history_float
    WHERE clock >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 WEEK))
    GROUP BY itemid
) id ON i.itemid = id.itemid
JOIN hosts_groups hg ON h.hostid = hg.hostid
JOIN groups g ON hg.groupid = g.groupid
WHERE g.name = %s AND i.key_ = 'system.cpu.util'
GROUP BY h.hostid
"""

# Retrieve data from the database
cursor = connection.cursor()
cursor.execute(query, (host_group,))
data = cursor.fetchall()

# Close the database connection
connection.close()

# Create a Pandas DataFrame from the retrieved data
df = pd.DataFrame(data, columns=['Host', 'Average CPU Utilization'])

# Create a new Excel workbook and write the DataFrame to it
wb = Workbook()
ws = wb.active
ws.append(df.columns.tolist())
for row in df.itertuples(index=False):
    ws.append(row)

# Save the Excel workbook
wb.save('zabbix_report.xlsx')
