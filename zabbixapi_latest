import requests
import pandas as pd

# Zabbix API URL
url = 'https://your-zabbix-instance.com/api_jsonrpc.php'

# Zabbix API credentials
username = 'your-username'
password = 'your-password'

# Hostgroup name for filtering
hostgroup_name = 'Your Hostgroup Name'

# Authenticate with the Zabbix API
session = requests.Session()
session.headers.update({'Content-Type': 'application/json'})
login_data = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': username,
        'password': password,
    },
    'id': 1,
}
response = session.post(url, json=login_data)
auth_result = response.json()
auth_token = auth_result['result']

# Get hosts in the specified hostgroup
hostgroup_data = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'output': 'extend',
        'filter': {
            'name': hostgroup_name,
        },
    },
    'auth': auth_token,
    'id': 2,
}
response = session.post(url, json=hostgroup_data)
hostgroup_result = response.json()
hostgroup_id = hostgroup_result['result'][0]['groupid']

# Get the latest item value for each host in the hostgroup
item_data = {
    'jsonrpc': '2.0',
    'method': 'item.get',
    'params': {
        'output': ['hostid', 'name', 'lastvalue'],
        'hostids': hostgroup_id,
        'search': {
            'key_': 'expiry',
        },
        'sortfield': 'name',
    },
    'auth': auth_token,
    'id': 3,
}
response = session.post(url, json=item_data)
item_result = response.json()

# Create a DataFrame to organize the data
data = []
for item in item_result['result']:
    data.append({
        'Hostname': item['host'],
        'Item Name': item['name'],
        'Last Value': item['lastvalue'],
    })
df = pd.DataFrame(data)

# Export data to Excel
excel_filename = 'zabbix_data.xlsx'
df.to_excel(excel_filename, index=False)

print(f'Data exported to {excel_filename}')

# Logout from the Zabbix API (optional)
logout_data = {
    'jsonrpc': '2.0',
    'method': 'user.logout',
    'params': [],
    'auth': auth_token,
    'id': 4,
}
session.post(url, json=logout_data)
