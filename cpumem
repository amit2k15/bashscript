import pymysql
import pandas as pd
from datetime import datetime, timedelta

# Database connection details
db_config = {
    'host': 'your_database_host',
    'user': 'your_database_user',
    'password': 'your_database_password',
    'database': 'zabbix_database',
}

# Zabbix item key and host group name
item_key = 'system.cpu.util[,idle]'
hostgroup_name = 'YourHostGroupName'

# Function to execute SQL query
def execute_query(query):
    connection = pymysql.connect(**db_config)
    try:
        with connection.cursor() as cursor:
            cursor.execute(query)
            result = cursor.fetchall()
            return result
    finally:
        connection.close()

# Function to get average CPU utilization for a specific host group
def get_average_cpu_utilization(start_date, end_date):
    query = f"""
        SELECT h.host, AVG(hi.value) as avg_cpu_utilization
        FROM hosts h
        JOIN items i ON h.hostid = i.hostid
        JOIN history hi ON i.itemid = hi.itemid
        JOIN hosts_groups hg ON h.hostid = hg.hostid
        JOIN groups g ON hg.groupid = g.groupid
        WHERE i.key_ = '{item_key}'
        AND g.name = '{hostgroup_name}'
        AND hi.clock >= UNIX_TIMESTAMP('{start_date}')
        AND hi.clock <= UNIX_TIMESTAMP('{end_date}')
        GROUP BY h.host
    """
    result = execute_query(query)
    return result

# Get the last week and last month dates
end_date_last_week = datetime.now()
start_date_last_week = end_date_last_week - timedelta(days=7)

end_date_last_month = datetime.now()
start_date_last_month = end_date_last_month - timedelta(days=30)

# Get average CPU utilization for last week
last_week_data = get_average_cpu_utilization(start_date_last_week, end_date_last_week)

# Get average CPU utilization for last month
last_month_data = get_average_cpu_utilization(start_date_last_month, end_date_last_month)

# Combine data into a single DataFrame
df_last_week = pd.DataFrame(last_week_data, columns=['Host', 'Avg_CPU_Last_Week'])
df_last_month = pd.DataFrame(last_month_data, columns=['Host', 'Avg_CPU_Last_Month'])

df_combined = pd.merge(df_last_week, df_last_month, on='Host', how='outer')

# Save the data to an Excel file
excel_file_path = 'cpu_utilization_report.xlsx'
df_combined.to_excel(excel_file_path, index=False)

print(f"Report generated successfully. Excel file saved at: {excel_file_path}")
