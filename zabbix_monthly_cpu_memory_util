import pandas as pd
from zabbix.api import ZabbixAPI

# Connect to the Zabbix API
zabbix_url = 'http://zabbix_server_ip/zabbix'
zabbix_user = 'username'
zabbix_password = 'password'
zapi = ZabbixAPI(url=zabbix_url, user=zabbix_user, password=zabbix_password)

# Specify the Zabbix host group and time interval
hostgroup_name = 'My Host Group'
time_from = '2022-01-01 00:00:00'
time_till = '2022-01-07 23:59:59'

# Retrieve the host IDs and names for the specified host group
hostgroup = zapi.hostgroup.get(filter={'name': hostgroup_name}, selectHosts='extend')[0]
host_ids = [h['hostid'] for h in hostgroup['hosts']]
host_names = [h['name'] for h in hostgroup['hosts']]

# Retrieve the CPU and memory utilization data for each host
data_frames = []
for host_id, host_name in zip(host_ids, host_names):
    cpu_util = zapi.history.get(itemids=zapi.item.get(filter={'hostid': host_id, 'key_': 'system.cpu.util'})[0]['itemid'],
                                time_from=time_from, time_till=time_till, output='extend')
    mem_util = zapi.history.get(itemids=zapi.item.get(filter={'hostid': host_id, 'key_': 'vm.memory.util'})[0]['itemid'],
                                time_from=time_from, time_till=time_till, output='extend')
    cpu_util_df = pd.DataFrame(cpu_util)
    mem_util_df = pd.DataFrame(mem_util)
    cpu_util_df['clock'] = pd.to_datetime(cpu_util_df['clock'], unit='s')
    mem_util_df['clock'] = pd.to_datetime(mem_util_df['clock'], unit='s')
    cpu_util_df = cpu_util_df.set_index('clock')
    mem_util_df = mem_util_df.set_index('clock')
    data_frames.append((host_name, cpu_util_df, mem_util_df))

# Write the data to an Excel file with individual sheets
with pd.ExcelWriter('utilization_data.xlsx') as writer:
    for host_name, cpu_util_df, mem_util_df in data_frames:
        cpu_util_df.to_excel(writer, sheet_name=f'{host_name} CPU')
        mem_util_df.to_excel(writer, sheet_name=f'{host_name} Memory')
