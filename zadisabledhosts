import requests
import openpyxl

# Zabbix API configuration
zabbix_url = 'https://your-zabbix-url/api_jsonrpc.php'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# API request headers
headers = {'Content-Type': 'application/json'}

# Zabbix API authentication
auth_payload = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password
    },
    'id': 1
}

response = requests.post(zabbix_url, json=auth_payload, headers=headers)
auth_result = response.json()

if 'result' in auth_result:
    auth_token = auth_result['result']
    print("Successfully authenticated.")
else:
    print("Authentication failed.")
    exit()

# Fetch disabled items
item_payload = {
    'jsonrpc': '2.0',
    'method': 'item.get',
    'params': {
        'output': ['name', 'status'],
        'selectHosts': ['host'],
        'filter': {'status': 1}  # 0 for enabled, 1 for disabled
    },
    'auth': auth_token,
    'id': 2
}

response = requests.post(zabbix_url, json=item_payload, headers=headers)
item_data = response.json()

# Create Excel workbook and sheet
workbook = openpyxl.Workbook()
sheet = workbook.active
sheet.title = 'Disabled Items Report'

# Add header row
sheet.append(['Item Name', 'Status', 'Host', 'Host Group'])

# Iterate through item data and fetch host and host group
for item in item_data['result']:
    item_name = item['name']
    item_status = 'Disabled'
    host_name = item['hosts'][0]['host']
    host_group = item['hosts'][0]['groups'][0]['name']

    sheet.append([item_name, item_status, host_name, host_group])

# Save the Excel file
excel_filename = 'disabled_items_report.xlsx'
workbook.save(excel_filename)
print(f"Excel report saved as '{excel_filename}'.")

# Logout
logout_payload = {
    'jsonrpc': '2.0',
    'method': 'user.logout',
    'params': [],
    'id': 3,
    'auth': auth_token
}

requests.post(zabbix_url, json=logout_payload, headers=headers)
print("Logged out from Zabbix.")
