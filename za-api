import requests
import json
from openpyxl import Workbook

# Zabbix API information
zabbix_api_url = 'https://your-zabbix-server/api_jsonrpc.php'
zabbix_username = 'your-username'
zabbix_password = 'your-password'

# Host group name you want to retrieve data for
host_group_name = 'Your Host Group Name'

# Zabbix API authentication
headers = {'Content-Type': 'application/json-rpc'}
auth_payload = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_username,
        'password': zabbix_password,
    },
    'id': 1,
}

response = requests.post(zabbix_api_url, data=json.dumps(auth_payload), headers=headers)
auth_result = response.json()

if 'result' not in auth_result:
    raise Exception('Zabbix authentication failed')

auth_token = auth_result['result']

# Get host group ID
host_group_payload = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'output': 'extend',
        'filter': {
            'name': [host_group_name],
        },
    },
    'auth': auth_token,
    'id': 2,
}

response = requests.post(zabbix_api_url, data=json.dumps(host_group_payload), headers=headers)
host_group_result = response.json()

if not host_group_result['result']:
    raise Exception('Host group not found')

host_group_id = host_group_result['result'][0]['groupid']

# Get hosts in the host group
host_payload = {
    'jsonrpc': '2.0',
    'method': 'host.get',
    'params': {
        'output': ['hostid', 'host', 'status'],
        'groupids': [host_group_id],
    },
    'auth': auth_token,
    'id': 3,
}

response = requests.post(zabbix_api_url, data=json.dumps(host_payload), headers=headers)
host_result = response.json()

if not host_result['result']:
    raise Exception('No hosts found in the host group')

hosts = host_result['result']

# Create an Excel workbook
wb = Workbook()
ws = wb.active
ws.title = 'Zabbix Host Data'

# Write headers to the Excel sheet
headers = ['Hostname', 'Host Status', 'Item Name', 'Item Status', 'Trigger Severity', 'Trigger Condition', 'Trigger Status']
ws.append(headers)

# Get item and trigger data for each host
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']
    host_status = host['status']

    # Get items for the host
    item_payload = {
        'jsonrpc': '2.0',
        'method': 'item.get',
        'params': {
            'output': ['name', 'status'],
            'hostids': [host_id],
        },
        'auth': auth_token,
        'id': 4,
    }

    response = requests.post(zabbix_api_url, data=json.dumps(item_payload), headers=headers)
    item_result = response.json()

    items = item_result['result']

    # Get triggers for the host
    trigger_payload = {
        'jsonrpc': '2.0',
        'method': 'trigger.get',
        'params': {
            'output': ['description', 'priority', 'expression', 'status'],
            'hostids': [host_id],
        },
        'auth': auth_token,
        'id': 5,
    }

    response = requests.post(zabbix_api_url, data=json.dumps(trigger_payload), headers=headers)
    trigger_result = response.json()

    triggers = trigger_result['result']

    # Write data to the Excel sheet
    for item in items:
        item_name = item['name']
        item_status = item['status']
        for trigger in triggers:
            trigger_description = trigger['description']
            trigger_priority = trigger['priority']
            trigger_status = trigger['status']

            # Map trigger priority to severity
            trigger_severity = {
                '1': 'Information',
                '2': 'Minor',
                '3': 'Warning',
                '4': 'Major',
            }.get(str(trigger_priority), 'Unknown')

            # Extract trigger condition from the expression
            trigger_expression = trigger['expression']
            trigger_condition = trigger_expression.split("{")[1].split("}")[0]

            # Append data to the Excel sheet
            data_row = [host_name, host_status, item_name, item_status, trigger_severity, trigger_condition, trigger_status]
            ws.append(data_row)

# Save the Excel workbook
wb.save('zabbix_host_data.xlsx')
print('Data saved to zabbix_host_data.xlsx')

# Logout from Zabbix API (optional)
logout_payload = {
    'jsonrpc': '2.0',
    'method': 'user.logout',
    'params': [],
    'auth': auth_token,
    'id': 6,
}

response = requests.post(zabbix_api_url, data=json.dumps(logout_payload), headers=headers)
