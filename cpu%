import pymysql
import openpyxl
from openpyxl.styles import Font

# MySQL Database Configuration
db_host = 'your_mysql_host'
db_user = 'your_mysql_user'
db_password = 'your_mysql_password'
db_name = 'your_zabbix_database'

# Zabbix Configuration
host_group = 'your_host_group_name'

# Excel Configuration
report_file = 'zabbix_report.xlsx'

# Connect to the MySQL database
connection = pymysql.connect(host=db_host, user=db_user, password=db_password, database=db_name)
cursor = connection.cursor()

# Retrieve the average CPU utilization for the last week
query = """
    SELECT h.host, AVG(hi.value) AS avg_cpu_utilization
    FROM hosts h
    INNER JOIN items i ON h.hostid = i.hostid
    INNER JOIN history hi ON i.itemid = hi.itemid
    WHERE h.hostid IN (
        SELECT hostid
        FROM hosts_groups
        WHERE groupid IN (
            SELECT groupid
            FROM groups
            WHERE name = %s
        )
    )
    AND i.name = 'system.cpu.util'
    AND hi.clock >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 WEEK))
    GROUP BY h.host
"""

cursor.execute(query, (host_group,))
results = cursor.fetchall()

# Create a new Excel workbook
workbook = openpyxl.Workbook()
sheet = workbook.active

# Write the column headers
sheet['A1'] = 'Host'
sheet['B1'] = 'Average CPU Utilization'
sheet['A1'].font = Font(bold=True)
sheet['B1'].font = Font(bold=True)

# Write the data to the worksheet
row = 2
for host, avg_cpu_utilization in results:
    sheet.cell(row=row, column=1).value = host
    sheet.cell(row=row, column=2).value = avg_cpu_utilization
    row += 1

# Save the workbook
workbook.save(report_file)

# Close the database connection
cursor.close()
connection.close()

print(f"Zabbix report generated successfully. File saved as '{report_file}'.")
