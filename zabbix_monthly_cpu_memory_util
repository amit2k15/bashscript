import requests
import json
import openpyxl
from datetime import datetime, timedelta

# Zabbix API credentials
zabbix_url = 'http://your-zabbix-server.com/api_jsonrpc.php'
zabbix_user = 'your-zabbix-api-user'
zabbix_password = 'your-zabbix-api-password'

# Zabbix host group name
host_group = 'your-zabbix-host-group'

# Time interval for data retrieval
start_time = '2022-01-01 00:00:00'
end_time = '2022-01-31 23:59:59'

# Zabbix API authentication
auth_payload = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password
    },
    'id': 1
}
auth_request = requests.post(zabbix_url, data=json.dumps(auth_payload))
auth_response = auth_request.json()
auth_token = auth_response['result']

# Retrieve host IDs from host group
host_payload = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'output': 'extend',
        'filter': {
            'name': [host_group]
        },
        'selectHosts': ['hostid']
    },
    'auth': auth_token,
    'id': 2
}
host_request = requests.post(zabbix_url, data=json.dumps(host_payload))
host_response = host_request.json()
host_ids = [host['hosts'][0]['hostid'] for host in host_response['result']]

# Retrieve system.cpu.util and vm.memory.util data for each host in host group
for host_id in host_ids:
    host_payload = {
        'jsonrpc': '2.0',
        'method': 'history.get',
        'params': {
            'output': 'extend',
            'history': [0, 1],
            'itemids': ['system.cpu.util', 'vm.memory.util'],
            'hostids': [host_id],
            'time_from': datetime.strptime(start_time, '%Y-%m-%d %H:%M:%S').timestamp(),
            'time_till': datetime.strptime(end_time, '%Y-%m-%d %H:%M:%S').timestamp(),
            'sortfield': 'clock',
            'sortorder': 'ASC'
        },
        'auth': auth_token,
        'id': 3
    }
    host_request = requests.post(zabbix_url, data=json.dumps(host_payload))
    host_response = host_request.json()
    
    # Create Excel workbook and worksheet for host
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = host_id
    
    # Write data to Excel worksheet
    for history in host_response['result']:
        timestamp = datetime.fromtimestamp(int(history['clock'])).strftime('%Y-%m-%d')
        cpu_util = history['value'] if history['itemid'] == 'system.cpu.util' else None
        memory_util = history['value'] if history['itemid'] == 'vm.memory.util' else None
        if cpu_util or memory_util:
            ws.append([timestamp, cpu_util, memory_util])
    
    # Save Excel workbook
    wb.save(f'{host_id}.xlsx')
