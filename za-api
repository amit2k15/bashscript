import openpyxl
from pyzabbix import ZabbixAPI

# Zabbix API details
zabbix_url = 'http://your_zabbix_server_url/zabbix'  # Replace with your Zabbix server URL
zabbix_user = 'your_username'
zabbix_password = 'your_password'

# Host group name and IDs (replace with your specific host group)
host_group_name = 'Your Host Group Name'
host_group_id = None

# Create a Zabbix API connection
zapi = ZabbixAPI(zabbix_url)
zapi.login(zabbix_user, zabbix_password)

# Get host group ID by name
host_groups = zapi.hostgroup.get(filter={"name": host_group_name})
if host_groups:
    host_group_id = host_groups[0]["groupid"]
else:
    print(f"Host group '{host_group_name}' not found.")
    zapi.logout()
    exit()

# Create a new Excel workbook
workbook = openpyxl.Workbook()
worksheet = workbook.active

# Set headers in the Excel sheet
worksheet.append(["Hostname", "Host Status", "Item Name", "Item Status", "Trigger Severity", "Trigger Condition", "Trigger Status"])

# Retrieve hosts in the specified host group
hosts = zapi.host.get(groupids=[host_group_id], output=["hostid", "host", "status"])
for host in hosts:
    hostid = host["hostid"]
    hostname = host["host"]
    host_status = "Enabled" if host["status"] == "0" else "Disabled"

    # Retrieve items for the host
    items = zapi.item.get(hostids=[hostid], output=["name", "status"])
    for item in items:
        item_name = item["name"]
        item_status = "Enabled" if item["status"] == "0" else "Disabled"

        # Retrieve triggers for the item
        triggers = zapi.trigger.get(itemids=[item["itemid"]], output=["description", "priority", "status"])
        for trigger in triggers:
            trigger_description = trigger["description"]
            trigger_severity = trigger["priority"]
            trigger_condition = trigger_description.split("{HOST.NAME} ")[1]
            trigger_status = "Enabled" if trigger["status"] == "0" else "Disabled"

            # Append data to the Excel sheet
            worksheet.append([hostname, host_status, item_name, item_status, trigger_severity, trigger_condition, trigger_status])

# Save the Excel file
excel_filename = 'zabbix_data.xlsx'
workbook.save(excel_filename)
print(f"Data saved to {excel_filename}")

# Logout from Zabbix API
zapi.logout()
