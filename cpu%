import pandas as pd
import mysql.connector
from datetime import datetime, timedelta
from openpyxl import Workbook

# Zabbix MySQL database connection details
db_config = {
    'host': 'your_host',
    'user': 'your_username',
    'password': 'your_password',
    'database': 'zabbix'
}

# Host group name
host_group = 'YourHostGroupName'

# Get the start and end dates for the last week and last month
end_date = datetime.now()
start_date_week = end_date - timedelta(weeks=1)
start_date_month = end_date - timedelta(days=30)

# Connect to the Zabbix database
db_conn = mysql.connector.connect(**db_config)
cursor = db_conn.cursor()

# Query to fetch average system CPU utilization for the specified host group and time range
query = '''
SELECT h.name AS Hostname, AVG(d.value) AS Avg_CPU_Utilization
FROM hosts h
JOIN items i ON h.hostid = i.hostid
JOIN history_uint d ON i.itemid = d.itemid
JOIN hosts_groups hg ON h.hostid = hg.hostid
JOIN groups g ON hg.groupid = g.groupid
WHERE g.name = %s
    AND i.key_ = 'system.cpu.util'
    AND d.clock BETWEEN %s AND %s
GROUP BY h.hostid, h.name
ORDER BY Avg_CPU_Utilization ASC
'''

# Execute the query for the last week
cursor.execute(query, (host_group, int(start_date_week.timestamp()), int(end_date.timestamp())))
data_week = cursor.fetchall()

# Execute the query for the last month
cursor.execute(query, (host_group, int(start_date_month.timestamp()), int(end_date.timestamp())))
data_month = cursor.fetchall()

# Create a Pandas DataFrame for the last week data
df_week = pd.DataFrame(data_week, columns=['Hostname', 'Avg_CPU_Utilization (Last Week)'])

# Create a Pandas DataFrame for the last month data
df_month = pd.DataFrame(data_month, columns=['Hostname', 'Avg_CPU_Utilization (Last Month)'])

# Create an Excel workbook and add the data to separate sheets
wb = Workbook()
ws_week = wb.active
ws_week.title = 'Last Week'
ws_month = wb.create_sheet(title='Last Month')

# Write the last week data to the worksheet
for r in dataframe_to_rows(df_week, index=False, header=True):
    ws_week.append(r)

# Write the last month data to the worksheet
for r in dataframe_to_rows(df_month, index=False, header=True):
    ws_month.append(r)

# Save the workbook
wb.save('zabbix_report.xlsx')

# Close the database connection
cursor.close()
db_conn.close()
