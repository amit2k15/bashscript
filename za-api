import requests
import openpyxl

# Zabbix API URL and credentials
zabbix_url = 'https://your-zabbix-url/api_jsonrpc.php'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Host group name to retrieve data for
host_group_name = 'Your Host Group Name'

# Zabbix API authentication
session = requests.Session()
login_data = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password
    },
    'id': 1,
}
response = session.post(zabbix_url, json=login_data)
auth_result = response.json()

if 'result' in auth_result:
    auth_token = auth_result['result']
else:
    raise Exception('Zabbix authentication failed')

# Get host group ID
get_host_group_data = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'filter': {
            'name': host_group_name
        },
        'output': 'extend'
    },
    'auth': auth_token,
    'id': 2,
}
response = session.post(zabbix_url, json=get_host_group_data)
host_group_result = response.json()

if not host_group_result['result']:
    raise Exception(f'Host group "{host_group_name}" not found')

host_group_id = host_group_result['result'][0]['groupid']

# Get hosts in the host group
get_hosts_data = {
    'jsonrpc': '2.0',
    'method': 'host.get',
    'params': {
        'groupids': [host_group_id],
        'output': ['hostid', 'host', 'status'],
        'selectItems': ['itemid', 'name', 'status'],
        'selectTriggers': ['triggerid', 'description', 'priority', 'value', 'status'],
        'expandData': '1'
    },
    'auth': auth_token,
    'id': 3,
}
response = session.post(zabbix_url, json=get_hosts_data)
hosts_result = response.json()

if 'result' not in hosts_result:
    raise Exception('Failed to retrieve hosts from Zabbix')

# Create an Excel workbook and worksheet
workbook = openpyxl.Workbook()
worksheet = workbook.active
worksheet.title = 'Zabbix Data'

# Add headers to the Excel sheet
headers = [
    'Hostname',
    'Host Status',
    'Item Name',
    'Item Status',
    'Trigger Severity',
    'Trigger Condition',
    'Trigger Status'
]
worksheet.append(headers)

# Iterate through the hosts and their items/triggers
for host in hosts_result['result']:
    hostname = host['host']
    host_status = host['status']
    
    for item in host['items']:
        item_name = item['name']
        item_status = item['status']
        
        for trigger in host['triggers']:
            trigger_severity = trigger['priority']
            trigger_condition = trigger['value']
            trigger_status = trigger['status']

            # Convert host status and trigger severity codes
            host_status = 'Enabled' if host_status == '0' else 'Disabled'
            trigger_severity = {
                '1': 'Information',
                '2': 'Minor',
                '3': 'Warning',
                '4': 'Major'
            }.get(str(trigger_severity), 'Unknown')

            # Add data to Excel sheet
            row_data = [
                hostname,
                host_status,
                item_name,
                item_status,
                trigger_severity,
                trigger_condition,
                trigger_status
            ]
            worksheet.append(row_data)

# Save the Excel file
workbook.save('zabbix_data.xlsx')

print('Data exported to zabbix_data.xlsx')
