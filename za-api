import requests
import json
import openpyxl

# Zabbix API settings
zabbix_api_url = 'https://your_zabbix_server/api_jsonrpc.php'
zabbix_user = 'your_username'
zabbix_password = 'your_password'

# Specify the host group name you want to retrieve data for
host_group_name = 'Your Host Group Name'

# Create a new Excel workbook and add a worksheet
wb = openpyxl.Workbook()
ws = wb.active
ws.title = 'Zabbix Host Data'

# Zabbix API authentication
headers = {'Content-Type': 'application/json'}
auth_payload = {
    "jsonrpc": "2.0",
    "method": "user.login",
    "params": {
        "user": zabbix_user,
        "password": zabbix_password
    },
    "id": 1
}
auth_response = requests.post(zabbix_api_url, data=json.dumps(auth_payload), headers=headers)
auth_result = auth_response.json()
auth_token = auth_result.get('result')

# Get host group ID by name
host_group_payload = {
    "jsonrpc": "2.0",
    "method": "hostgroup.get",
    "params": {
        "output": "extend",
        "filter": {
            "name": [host_group_name]
        }
    },
    "auth": auth_token,
    "id": 2
}
host_group_response = requests.post(zabbix_api_url, data=json.dumps(host_group_payload), headers=headers)
host_group_result = host_group_response.json()
host_group_id = host_group_result['result'][0]['groupid']

# Get hosts in the specified host group
host_payload = {
    "jsonrpc": "2.0",
    "method": "host.get",
    "params": {
        "output": ["hostid", "host"],
        "groupids": host_group_id
    },
    "auth": auth_token,
    "id": 3
}
host_response = requests.post(zabbix_api_url, data=json.dumps(host_payload), headers=headers)
hosts = host_response.json()['result']

# Write headers to the Excel sheet
headers = ["Hostname", "Host Status", "Item Name", "Item Status", "Trigger Severity", "Trigger Condition", "Trigger Status"]
ws.append(headers)

# Retrieve item and trigger data for each host
for host in hosts:
    hostid = host['hostid']
    
    # Get items for the host
    item_payload = {
        "jsonrpc": "2.0",
        "method": "item.get",
        "params": {
            "output": ["name", "status"],
            "hostids": hostid
        },
        "auth": auth_token,
        "id": 4
    }
    item_response = requests.post(zabbix_api_url, data=json.dumps(item_payload), headers=headers)
    items = item_response.json()['result']
    
    # Get triggers for the host
    trigger_payload = {
        "jsonrpc": "2.0",
        "method": "trigger.get",
        "params": {
            "output": ["description", "priority", "expression", "status"],
            "hostids": hostid,
            "expandExpression": True
        },
        "auth": auth_token,
        "id": 5
    }
    trigger_response = requests.post(zabbix_api_url, data=json.dumps(trigger_payload), headers=headers)
    triggers = trigger_response.json()['result']
    
    # Write data to the Excel sheet
    for item in items:
        for trigger in triggers:
            row_data = [
                host['host'],
                host['status'],
                item['name'],
                item['status'],
                trigger['priority'],
                trigger['expression'],
                trigger['status']
            ]
            ws.append(row_data)

# Save the Excel file
wb.save('ZabbixHostData.xlsx')
print('Data exported to ZabbixHostData.xlsx')

# Logout from the Zabbix API
logout_payload = {
    "jsonrpc": "2.0",
    "method": "user.logout",
    "params": [],
    "auth": auth_token,
    "id": 6
}
logout_response = requests.post(zabbix_api_url, data=json.dumps(logout_payload), headers=headers)
