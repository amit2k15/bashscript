import pandas as pd
from openpyxl import Workbook
from pyzabbix import ZabbixAPI

# Zabbix API credentials and settings
ZABBIX_URL = 'https://your.zabbix.server/api_jsonrpc.php'
ZABBIX_USER = 'your_zabbix_username'
ZABBIX_PASSWORD = 'your_zabbix_password'
ZABBIX_HOSTGROUP = 'your_host_group_name'

# Custom time interval (in seconds)
START_TIME = pd.Timestamp('2023-04-01 00:00:00')
END_TIME = pd.Timestamp('2023-05-01 00:00:00')

# Connect to Zabbix API
zapi = ZabbixAPI(ZABBIX_URL)
zapi.login(ZABBIX_USER, ZABBIX_PASSWORD)

# Get list of hosts in host group
hostgroup = zapi.hostgroup.get(filter={'name': ZABBIX_HOSTGROUP})
hostids = [host['hostid'] for host in hostgroup[0]['hosts']]

# Get CPU and memory data for each host in time range
items = zapi.item.get(
    hostids=hostids,
    search={'key_': ['system.cpu.util', 'vm.memory.util']},
    output=['name', 'key_', 'lastvalue'],
    selectHosts=['host'],
    sortfield='name',
)

data = {}
for item in items:
    host = item['hosts'][0]['host']
    key = item['key_']
    name = item['name']
    history = zapi.history.get(
        itemids=item['itemid'],
        time_from=int(START_TIME.timestamp()),
        time_till=int(END_TIME.timestamp()),
        output='extend',
        history=0,  # use numeric value for "float" history
    )
    values = [float(h['value']) for h in history]
    timestamps = [pd.Timestamp.fromtimestamp(int(h['clock'])) for h in history]
    df = pd.DataFrame({'Timestamp': timestamps, name: values})
    if host not in data:
        data[host] = df
    else:
        data[host] = pd.merge(data[host], df, on='Timestamp')

# Create Excel file with individual sheets for each host
with pd.ExcelWriter('zabbix_data.xlsx') as writer:
    for host, df in data.items():
        sheet_name = host.replace('/', '_')[:31]  # limit sheet name length
        df.to_excel(writer, sheet_name=sheet_name, index=False)
