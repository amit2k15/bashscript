import pandas as pd
import pyzabbix
from datetime import datetime, timedelta

# Zabbix server credentials
zabbix_url = 'http://zabbix_server_url/zabbix/api_jsonrpc.php'
zabbix_user = 'username'
zabbix_password = 'password'

# Zabbix host group name
host_group = 'My Host Group'

# Time interval for data retrieval
start_time = datetime(2023, 4, 1, 0, 0, 0)
end_time = datetime(2023, 4, 30, 23, 59, 59)

# Connect to the Zabbix server
zapi = pyzabbix.ZabbixAPI(url=zabbix_url, user=zabbix_user, password=zabbix_password)

# Get the hosts in the specified host group
host_ids = [host['hostid'] for host in zapi.hostgroup.get_hosts(groupids=zapi.hostgroup.get(filter={"name": host_group})[0]['groupid'])]

# Create an Excel file with individual sheets for each host
writer = pd.ExcelWriter('host_metrics.xlsx', engine='xlsxwriter')

# Loop through each host and generate the metrics data
for host_id in host_ids:
    host_name = zapi.host.get(hostids=host_id)[0]['name']

    # Get the system CPU utilization data
    cpu_data = zapi.history.get(itemids=zapi.item.get(filter={"hostid": host_id, "name": "system.cpu.util"})[0]['itemid'],
                                time_from=int(start_time.timestamp()),
                                time_till=int(end_time.timestamp()),
                                output='extend',
                                limit=0)

    # Convert the CPU utilization data to a Pandas DataFrame and resample to day-wise data
    cpu_df = pd.DataFrame(cpu_data)
    cpu_df['value'] = cpu_df['value'].astype(float)
    cpu_df['clock'] = pd.to_datetime(cpu_df['clock'], unit='s')
    cpu_df = cpu_df.set_index('clock').resample('D').mean()

    # Get the VM memory utilization data
    mem_data = zapi.history.get(itemids=zapi.item.get(filter={"hostid": host_id, "name": "vm.memory.util"})[0]['itemid'],
                                time_from=int(start_time.timestamp()),
                                time_till=int(end_time.timestamp()),
                                output='extend',
                                limit=0)

    # Convert the VM memory utilization data to a Pandas DataFrame and resample to day-wise data
    mem_df = pd.DataFrame(mem_data)
    mem_df['value'] = mem_df['value'].astype(float)
    mem_df['clock'] = pd.to_datetime(mem_df['clock'], unit='s')
    mem_df = mem_df.set_index('clock').resample('D').mean()

    # Write the data to a sheet in the Excel file
    cpu_df.to_excel(writer, sheet_name=f'{host_name} - CPU')
    mem_df.to_excel(writer, sheet_name=f'{host_name} - Memory')

# Save the Excel file
writer.save()
