import requests
import json
import openpyxl

# Zabbix API details
zabbix_url = 'https://your-zabbix-server/api_jsonrpc.php'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Authenticate and get the Zabbix API token
headers = {'Content-Type': 'application/json-rpc'}
data = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password,
    },
    'id': 1,
}
response = requests.post(zabbix_url, data=json.dumps(data), headers=headers)
result = response.json()

if 'result' in result:
    auth_token = result['result']
else:
    print("Login failed. Check your credentials.")
    exit()

# Get disabled items
data = {
    'jsonrpc': '2.0',
    'method': 'item.get',
    'params': {
        'output': ['hostid', 'name', 'status'],
        'filter': {'status': 1},  # 1 indicates disabled items
        'selectHosts': ['host'],
    },
    'auth': auth_token,
    'id': 2,
}
response = requests.post(zabbix_url, data=json.dumps(data), headers=headers)
result = response.json()

if 'result' in result:
    disabled_items = result['result']
else:
    print("Failed to fetch disabled items.")
    exit()

# Create an Excel workbook and worksheet
workbook = openpyxl.Workbook()
worksheet = workbook.active
worksheet.title = "Disabled Items"

# Write headers
headers = ['Host', 'Host Group', 'Item Name']
worksheet.append(headers)

# Get host and host group information for each disabled item
for item in disabled_items:
    host = item['hosts'][0]['host']
    host_group = item['hosts'][0]['groups'][0]['name']
    item_name = item['name']
    worksheet.append([host, host_group, item_name])

# Save the workbook
report_filename = 'disabled_items_report.xlsx'
workbook.save(report_filename)
print(f"Report saved as {report_filename}")
