import pyexcel as pe
from pyzabbix import ZabbixAPI

# Zabbix API configuration
ZABBIX_URL = 'http://your_zabbix_server_url'
ZABBIX_USER = 'your_username'
ZABBIX_PASSWORD = 'your_password'

# Host group and timeframe configuration
HOST_GROUP_NAME = 'Your_Host_Group_Name'
TIME_RANGE = 604800  # 1 week in seconds

# Connect to Zabbix API
zabbix = ZabbixAPI(ZABBIX_URL)
zabbix.login(ZABBIX_USER, ZABBIX_PASSWORD)

# Get host group ID
host_group = zabbix.hostgroup.get(filter={'name': HOST_GROUP_NAME})
if not host_group:
    raise ValueError(f"Host group '{HOST_GROUP_NAME}' not found.")
host_group_id = host_group[0]['groupid']

# Get average CPU utilization for each host in the host group for the last week
items = zabbix.item.get(filter={'hostgroupids': host_group_id, 'key_': 'system.cpu.util[,idle]'}, output=['name', 'lastvalue'])
report_data = [['Host', 'Average CPU Utilization (%)']]

for item in items:
    history = zabbix.history.get(itemids=item['itemid'], time_from=TIME_RANGE, history=0, output='extend')
    if history:
        cpu_values = [float(h['value']) for h in history]
        avg_cpu = sum(cpu_values) / len(cpu_values)
        report_data.append([item['name'], avg_cpu])

# Generate Excel report
sheet = pe.Sheet(report_data)
sheet.save_as('cpu_utilization_report.xlsx')

print("Report generated successfully.")
