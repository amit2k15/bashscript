import openpyxl
from pyzabbix import ZabbixAPI
import time

# Zabbix API credentials
zabbix_server = 'https://your.zabbix.server.com/'
zabbix_user = 'your_zabbix_user'
zabbix_password = 'your_zabbix_password'

# Zabbix host group and time interval
host_group = 'your_host_group_name'
from_time = int(time.mktime(time.strptime('2023-04-01 00:00:00', '%Y-%m-%d %H:%M:%S')))
to_time = int(time.mktime(time.strptime('2023-04-30 23:59:59', '%Y-%m-%d %H:%M:%S')))

# Connect to Zabbix API
zabbix = ZabbixAPI(zabbix_server)
zabbix.login(zabbix_user, zabbix_password)

# Get hosts in host group
hosts = zabbix.host.get(groupids=zabbix.hostgroup.get(filter={"name": host_group})[0]['groupid'], output='extend')

# Create Excel workbook and worksheets
wb = openpyxl.Workbook()
for host in hosts:
    ws = wb.create_sheet(title=host['name'])

    # Get CPU and memory utilization data for host
    cpu_util_data = zabbix.history.get(itemids=zabbix.item.get(hostids=host['hostid'], search={'key_': 'system.cpu.util'})[0]['itemid'], time_from=from_time, time_till=to_time, output='extend')
    memory_util_data = zabbix.history.get(itemids=zabbix.item.get(hostids=host['hostid'], search={'key_': 'vm.memory.util'})[0]['itemid'], time_from=from_time, time_till=to_time, output='extend')

    # Write utilization data to worksheet
    ws.cell(row=1, column=1, value='Timestamp')
    ws.cell(row=1, column=2, value='CPU Utilization (%)')
    ws.cell(row=1, column=3, value='Memory Utilization (%)')
    for i in range(len(cpu_util_data)):
        ws.cell(row=i+2, column=1, value=time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(int(cpu_util_data[i]['clock']))))
        ws.cell(row=i+2, column=2, value=cpu_util_data[i]['value'])
        ws.cell(row=i+2, column=3, value=memory_util_data[i]['value'])

# Save Excel workbook
wb.save('utilization_data.xlsx')
