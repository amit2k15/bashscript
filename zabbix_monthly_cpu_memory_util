import pandas as pd
import requests
import json
import time
import datetime
from pyzabbix import ZabbixAPI

# Zabbix server details
zabbix_server = 'http://<zabbix_server_ip>'
zabbix_user = '<zabbix_username>'
zabbix_password = '<zabbix_password>'

# Zabbix API connection
zapi = ZabbixAPI(zabbix_server)
zapi.login(zabbix_user, zabbix_password)

# Host group and time range
host_group_name = '<host_group_name>'
start_time = datetime.datetime.now() - datetime.timedelta(days=7)
end_time = datetime.datetime.now()

# Get host IDs in the host group
host_group = zapi.hostgroup.get(filter={'name': host_group_name}, output=['groupid'])
host_group_id = host_group[0]['groupid']
hosts = zapi.host.get(groupids=host_group_id, output=['hostid', 'host'])

# Initialize pandas dataframes
cpu_df = pd.DataFrame(columns=['host', 'timestamp', 'value'])
memory_df = pd.DataFrame(columns=['host', 'timestamp', 'value'])

# Loop through each host and get CPU and memory data
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']
    print('Processing host:', host_name)

    # Get CPU data
    cpu_data = zapi.history.get(itemids=[23368], hostids=host_id, history=0, time_from=int(time.mktime(start_time.timetuple())), time_till=int(time.mktime(end_time.timetuple())), output=['clock', 'value'])
    for data in cpu_data:
        cpu_df = cpu_df.append({'host': host_name, 'timestamp': datetime.datetime.fromtimestamp(int(data['clock'])).strftime('%Y-%m-%d %H:%M:%S'), 'value': data['value']}, ignore_index=True)

    # Get memory data
    memory_data = zapi.history.get(itemids=[23375], hostids=host_id, history=0, time_from=int(time.mktime(start_time.timetuple())), time_till=int(time.mktime(end_time.timetuple())), output=['clock', 'value'])
    for data in memory_data:
        memory_df = memory_df.append({'host': host_name, 'timestamp': datetime.datetime.fromtimestamp(int(data['clock'])).strftime('%Y-%m-%d %H:%M:%S'), 'value': data['value']}, ignore_index=True)

# Write data to separate sheets in an Excel file
writer = pd.ExcelWriter('zabbix_data.xlsx', engine='xlsxwriter')
cpu_df.to_excel(writer, sheet_name='CPU')
memory_df.to_excel(writer, sheet_name='Memory')
writer.save()
